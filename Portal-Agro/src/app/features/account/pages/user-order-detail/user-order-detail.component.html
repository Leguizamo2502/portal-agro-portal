<div class="wrap">
  <div class="header"id="order-header">
    <!-- <app-button [text]="'Volver'" [icon]="'arrow_back'" [back]="true"></app-button> -->
    <h2 class="title">Detalle del Pedido</h2>
  </div>

  <ng-container *ngIf="!loading && detail; else loadingTpl">
    <div class="card"id="order-card" >
      <div class="card-head" id="order-head">
        <div class="id subtitle">Pedido #{{ detail!.id }}</div>
        <span [class]="statusChip.cls">{{ statusChip.text }}</span>
      </div>

      <div class="grid">
        <!-- resumen -->
        <section id="order-summary">
          <h3 class="title">Resumen</h3>
          <div class="row">
            <div class="subtitle label">Producto</div>
            <div class="text value">{{ detail!.productName }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Precio unitario</div>
            <div class="text value">{{ detail!.unitPrice | currency:'COP' }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Cantidad</div>
            <div class="text value">{{ detail!.quantityRequested }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Subtotal</div>
            <div class="text value">{{ detail!.subtotal | currency:'COP' }}</div>
          </div>
          <div class="row total">
            <div class="subtitle label">Total</div>
            <div class="text value strong">{{ detail!.total | currency:'COP' }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Creado</div>
            <div class="text value">{{ detail!.createAt | date:'mediumDate':'':'es-CO' }}</div>
          </div>
        </section>

        <!-- entrega -->
        <section id="order-delivery">
          <h3 class="title">Entrega</h3>
          <div class="row">
            <div class="subtitle label">Destinatario</div>
            <div class="text value">{{ detail!.recipientName }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Teléfono</div>
            <div class="text value">{{ detail!.contactPhone }}</div>
          </div>
          <div class="row">
            <div class="subtitle label">Dirección</div>
            <div class="text value">
              {{ detail!.addressLine1 }}
              <ng-container *ngIf="detail!.addressLine2">, {{ detail!.addressLine2 }}</ng-container>
            </div>
          </div>
          <div class="row">
            <div class="subtitle label">Ciudad</div>
            <div class="text value">{{ detail!.cityName || ('#' + detail!.cityId) }}</div>
          </div>
        </section>

        <!-- comprobante -->
        <section id="order-payment">
          <h3 class="title">Comprobante de Pago</h3>
          <ng-container *ngIf="detail!.paymentImageUrl; else noImg">
            <img class="receipt" [src]="detail!.paymentImageUrl!" alt="Comprobante"
                (click)="showImage = true" />
            <div class="muted">Subido: {{ detail!.paymentUploadedAt | date:'medium' }}</div>
          </ng-container>
          <ng-template #noImg>
            <div class="muted">No disponible.</div>
          </ng-template>

          <!-- acción subir comprobante (solo AcceptedAwaitingPayment) -->
          <div class="mt" *ngIf="canUploadPayment">
            <input type="file" accept="image/*" #paymentInput hidden (change)="onPickPaymentFile($event)" />
            <app-button text="Subir comprobante" color="primary" (clicked)="triggerFile(paymentInput)"data-tour-open></app-button>
            <div class="muted small">Formatos: JPG/PNG/WEBP · Máx {{ MAX_FILE_MB }} MB</div>
          </div>
        </section>
      </div>

      <!-- notas/decisión productor -->
      <div class="producer-block" *ngIf="detail!.producerDecisionAt" id="order-producer">
        <div class="row">
          <div class="subtitle label">Fecha decisión productor</div>
          <div class="text value">{{ detail!.producerDecisionAt | date:'medium' }}</div>
        </div>
        <div class="row" *ngIf="detail!.producerNotes"id="order-producer">
          <div class="subtitle label">Notas del productor</div>
          <div class="text value">{{ detail!.producerNotes }}</div>
        </div>
        <div class="row" *ngIf="detail!.producerDecisionReason">
          <div class="subtitle label">Motivo</div>
          <div class="text value">{{ detail!.producerDecisionReason }}</div>
        </div>
      </div>

      <!-- acciones -->
      <div class="actions" id="order-actions" *ngIf="canConfirm">
        <app-button
          [text]="'No, hubo problema'"
          [color]="'danger'"
          [disabled]="confirming"
          (clicked)="confirm('no')">
        </app-button>

        <app-button
          [text]="'Sí, recibido'"
          [color]="'primary'"
          [disabled]="confirming"
          (clicked)="confirm('yes')">
        </app-button>
      </div>

      <div class="muted" *ngIf="!canConfirm">
        <i>La confirmación aparece cuando el productor marca tu pedido como entregado.</i>
      </div>

      <!-- cancelar (solo PendingReview) -->
      <div class="actions mt" id="order-cancel" *ngIf="canCancel" data-tour-open>
        <app-button text="Cancelar pedido" color="danger" (clicked)="cancel()"></app-button>
      </div>
    </div>
  </ng-container>

  <ng-template #loadingTpl>
    <div class="card skeleton">
      <div class="line w40"></div>
      <div class="line"></div>
      <div class="line w60"></div>
    </div>
  </ng-template>

  <!-- visor simple para la imagen -->
  <div class="lightbox" *ngIf="showImage" (click)="showImage = false">
    <img [src]="detail?.paymentImageUrl || ''" alt="Comprobante ampliado" />
  </div>
</div>
